# For testing, increase the rate value
limit_req_zone $binary_remote_addr zone=general:10m rate=5r/s;
limit_conn_zone $binary_remote_addr zone=consent:10m;

server {

	# SSL configuration
	#
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	ssl_stapling on;
	# ssl_session_cache  builtin:1000  shared:SSL:10m;

	# gzip settings
	gzip on;
	gzip_types application/json;
	gzip_proxied any;
	gzip_min_length 1000; # gzip performed when Content-Length > 1000 bytes

	server_name CONSENT_DOMAIN;

	location / {

	limit_conn consent 100;
	limit_req zone=general burst=5 nodelay;

        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;

        proxy_pass          http://localhost:3000/consent/;

	}

	error_page 502 /bad_gateway.json;
	error_page 503 /service_unavailable.json;

	location /bad_gateway.json {
		return 502 '{"error":{"message":"Bad gateway"}}\n';
	}

	location /service_unavailable.json {
		return 503 '{"error":{"message":"Service unavailable"}}\n';
	}

    listen [::]:443 ; 
    listen 443 ssl; 
    ssl_certificate /home/iudx-auth-server/https-certificate.pem;
    ssl_certificate_key /home/iudx-auth-server/https-key.pem;

}


# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}
